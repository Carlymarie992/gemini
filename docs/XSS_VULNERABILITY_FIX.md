# Angular XSS Vulnerability Fix - GHSA-v4hv-rgfq-gp49

## Overview

This document describes the fix for the Angular Stored Cross-Site Scripting (XSS) vulnerability identified as GHSA-v4hv-rgfq-gp49.

## Vulnerability Details

### Description

The Angular Template Compiler had an incomplete security schema that failed to properly classify certain URL-holding attributes as requiring strict URL security. This allowed attackers to bypass Angular's built-in security sanitization and inject malicious JavaScript code.

### Affected Attributes

1. **SVG-related attributes**:
   - `xlink:href` on SVG elements
   - Various other SVG namespace attributes

2. **MathML attributes**:
   - `math|href`
   - `annotation|href`
   - Other MathML namespace URL attributes

3. **SVG Animation elements**:
   - `<animate>`
   - `<set>`
   - `<animateMotion>`
   - `<animateTransform>`
   - Specifically, the `attributeName` attribute on these elements

### Attack Vector

When template binding was used to assign untrusted, user-controlled data to these attributes, the compiler incorrectly fell back to a non-sanitizing context. For example:

```html
<!-- Vulnerable code (before fix) -->
<svg>
  <a [attr.xlink:href]="userControlledURL">Click me</a>
</svg>

<!-- If userControlledURL = "javascript:alert('XSS')", this would execute -->

<!-- SVG Animation attack -->
<svg>
  <animate [attributeName]="'href'" [values]="userControlledURL"></animate>
</svg>

<!-- If userControlledURL = "javascript:alert('XSS')", this would execute -->
```

### Impact

When exploited, this vulnerability allows attackers to:
- Execute arbitrary JavaScript code in the application's origin context
- Steal session cookies and authentication tokens
- Capture and transmit sensitive user data
- Perform unauthorized actions on behalf of the user
- Deface the application
- Redirect users to malicious sites

### Attack Preconditions

For successful exploitation:
1. The application must render data from untrusted input (e.g., from a database, API, or user input)
2. The untrusted data must be bound to one of the vulnerable attributes using Angular template syntax
3. The user must interact with the compromised element (e.g., click on it) or the animation must trigger automatically

## Fix Implementation

### Angular Version Update

The fix was implemented by updating Angular packages to version 20.3.15, which includes the security patches:

**Updated packages** (in `package.json`):
```json
{
  "dependencies": {
    "@angular/common": "^20.3.15",
    "@angular/compiler": "^20.3.15",
    "@angular/compiler-cli": "^20.3.15",
    "@angular/core": "^20.3.15",
    "@angular/forms": "^20.3.15",
    "@angular/platform-browser": "^20.3.15",
    "@angular/router": "^20.3.15"
  }
}
```

**Note**: `@angular/build` and `@angular/cli` remain at version 20.3.13 as the security vulnerability specifically affects the compiler and runtime packages, and version 20.3.15 is not yet available for these build tools. The security fix is contained in the core Angular packages listed above.

### What Changed in Angular 20.3.15

The Angular team made the following changes to the compiler's security schema:

1. **Enhanced URL Attribute Classification**: The compiler now properly classifies SVG and MathML URL attributes as security-sensitive, requiring URL sanitization.

2. **SVG Animation Validation**: The `attributeName` attribute on SVG animation elements is now validated to prevent targeting security-sensitive attributes like `href` or `xlink:href`.

3. **Improved Sanitization Context**: When template bindings target these attributes, the compiler now uses the appropriate sanitization context (URL sanitization) instead of falling back to a non-sanitizing context.

### Verification

After applying the fix:

```bash
# Check for vulnerabilities
npm audit

# Result: found 0 vulnerabilities
```

All Angular packages are now at version 20.3.15 or later, which includes the security fix.

## Additional Security Measures

In addition to the Angular update, this application implements several defense-in-depth security measures in the `SecurityService`:

1. **Input Sanitization**: The `sanitizeInput()` method removes:
   - `javascript:` protocol URLs
   - `vbscript:` protocol URLs
   - Script tags
   - Event handlers (onclick, onerror, etc.)
   - Iframe tags
   - Object and embed tags
   - Dangerous data URLs

2. **HTML Sanitization**: The `sanitizeHTML()` method:
   - Uses DOMParser for safe HTML parsing
   - Allows only specific safe tags (p, br, b, i, u, em, strong, a, ul, ol, li, blockquote)
   - Removes all attributes except href on links
   - Chains with sanitizeInput() for additional protection

3. **Prompt Injection Detection**: The service detects and prevents prompt injection attacks on AI-generated content.

4. **Secure Environment Validation**: Checks for HTTPS in production to protect data in transit.

## Testing

A comprehensive test suite has been created in `src/services/security.service.spec.ts` that validates:

1. Removal of `javascript:` protocol URLs
2. Sanitization of script tags and event handlers
3. Protection against SVG and MathML XSS vectors
4. Safe handling of SVG animation attributes
5. Proper HTML sanitization
6. Prompt injection detection
7. Sensitive data redaction

To run tests (when test infrastructure is configured):
```bash
npm test
```

## Prevention Best Practices

To prevent similar vulnerabilities in the future:

1. **Always use Angular's data binding**: Use `[property]` binding or interpolation `{{ }}` instead of string concatenation for dynamic content.

2. **Trust Angular's built-in sanitization**: Angular automatically sanitizes values bound to properties like `innerHTML`, `href`, and `src`.

3. **Keep Angular updated**: Regularly update Angular to get the latest security fixes.

4. **Be cautious with `bypassSecurityTrust*` methods**: Only use these when you have complete control over the data source and have manually validated/sanitized the content.

5. **Validate and sanitize user input**: Always validate and sanitize data from untrusted sources at both the client and server levels.

6. **Use Content Security Policy (CSP)**: Implement a strict CSP to prevent execution of inline scripts and restrict script sources.

7. **Regular security audits**: Run `npm audit` regularly to check for known vulnerabilities in dependencies.

## References

- **GitHub Advisory**: [GHSA-v4hv-rgfq-gp49](https://github.com/advisories/GHSA-v4hv-rgfq-gp49)
- **CVE**: CWE-79 (Improper Neutralization of Input During Web Page Generation)
- **Angular Security Guide**: https://angular.dev/best-practices/security
- **OWASP XSS Prevention**: https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html

## Timeline

- **Vulnerability Disclosed**: November 2024
- **Angular Fix Released**: 20.3.15, 21.0.2 (December 2024)
- **Fix Applied to Project**: December 5, 2024
- **Verification**: npm audit shows 0 vulnerabilities

## Contact

For security concerns, please see our [Security Policy](SECURITY.md).
